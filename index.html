<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini PWA Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gemini Chat">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            transition: background-color 0.3s ease;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 sm:p-6 lg:p-8">
    <div id="root" class="w-full max-w-2xl bg-white rounded-2xl shadow-xl flex flex-col h-[80vh] overflow-hidden">
        <div id="chat-history" class="flex-grow overflow-y-auto p-4 sm:p-6 space-y-4"></div>

        <div class="p-4 sm:p-6 bg-gray-50 border-t border-gray-200">
            <form id="chat-form" class="flex items-center space-x-2">
                <input id="chat-input" type="text" placeholder="Type a message..." class="flex-grow p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow">
                <button type="submit" class="bg-blue-600 text-white rounded-xl p-3 shadow-md hover:bg-blue-700 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 2L11 13M22 2L15 22L11 13L2 9L22 2Z" />
                    </svg>
                </button>
            </form>
        </div>
    </div>

    <script>
        // API Configuration
        // IMPORTANT: Replace "YOUR_API_KEY" with your actual Google AI Studio API key.
        const API_KEY = "AIzaSyDHOsep4QtiL0WRmPw47WRC2PVEHhaiNg8"; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        const chatHistory = document.getElementById('chat-history');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        
        let conversation = [];

        // Appends a new message to the chat history
        function appendMessage(role, text) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('flex', 'flex-col', 'gap-2');

            const messageText = document.createElement('div');
            messageText.classList.add(
                'rounded-lg', 'p-3', 'max-w-[85%]', 'whitespace-pre-wrap', 'break-words', 'shadow-sm',
                role === 'user' ? 'self-end bg-blue-100 text-gray-800' : 'self-start bg-gray-100 text-gray-800'
            );
            messageText.innerText = text;

            messageDiv.appendChild(messageText);
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight; // Auto-scroll to the bottom
        }

        // Handles the form submission
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const prompt = chatInput.value.trim();
            if (!prompt) return;

            // Display user message
            appendMessage('user', prompt);
            conversation.push({ role: 'user', parts: [{ text: prompt }] });
            chatInput.value = '';

            // Display loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading';
            loadingDiv.classList.add('self-start', 'text-gray-500', 'p-3');
            loadingDiv.innerHTML = '<span class="animate-pulse">Thinking...</span>';
            chatHistory.appendChild(loadingDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;

            try {
                const payload = {
                    contents: conversation,
                    tools: [{ "google_search": {} }]
                };
                
                // Exponential backoff retry logic
                let response;
                let retries = 0;
                const maxRetries = 5;
                while (retries < maxRetries) {
                    try {
                        response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            break; // Success, exit loop
                        } else if (response.status === 429) {
                            retries++;
                            const delay = Math.pow(2, retries) * 1000;
                            console.error(`Rate limit exceeded. Retrying in ${delay / 1000} seconds...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                        } else {
                            throw new Error(`API error: ${response.statusText}`);
                        }
                    } catch (error) {
                        console.error('Fetch error:', error);
                        throw error;
                    }
                }

                if (!response || !response.ok) {
                    throw new Error('Failed to get a response from the API after multiple retries.');
                }
                
                const result = await response.json();
                const candidate = result.candidates?.[0];
                const aiResponse = candidate?.content?.parts?.[0]?.text || "No response found.";

                // Remove loading indicator
                const loadingIndicator = document.getElementById('loading');
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }

                // Display AI response
                appendMessage('ai', aiResponse);
                conversation.push({ role: 'model', parts: [{ text: aiResponse }] });

            } catch (error) {
                console.error('Error fetching from API:', error);
                
                const loadingIndicator = document.getElementById('loading');
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }

                // Display an error message to the user
                appendMessage('ai', 'Oops! Something went wrong. Please try again.');
            }
        });
        
        // Register the Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>