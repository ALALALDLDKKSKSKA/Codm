<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <!-- Meta tags for full-screen mode on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CODM Loadouts">
    
    <title>CODM Loadouts for YOU!!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="/manifest.json">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        /* Custom keyboard styling */
        .custom-keyboard {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #212121;
            padding: 0.5rem;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
        }
        .custom-keyboard.is-visible {
            transform: translateY(0);
        }
        .key-row {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            justify-content: center;
        }
        .key-button {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 3rem;
            flex-grow: 1;
            border-radius: 0.5rem;
            background-color: #525252;
            color: #f0f0f0;
            font-size: 1.5rem;
            font-weight: bold;
            transition: background-color 0.1s, transform 0.1s;
            touch-action: manipulation;
        }
        .key-button:active {
            background-color: #7a7a7a;
            transform: scale(0.95);
        }
        .special-key {
            background-color: #7a7a7a;
        }
        .special-key:active {
            background-color: #a0a0a0;
        }
        .space-key {
            flex-grow: 5;
        }
        .shift-key, .backspace-key {
            flex-grow: 1.5;
        }
        .period-key, .comma-key {
            flex-grow: 1.1;
        }
        .done-key {
            flex-grow: 2;
        }
        
        /* Typing indicator animation */
        .typing-indicator {
            width: 2px;
            height: 1.5rem;
            background-color: #fff;
            margin-left: 0.25rem;
            animation: blink-caret 0.75s step-end infinite;
        }
        @keyframes blink-caret {
            from, to { opacity: 0; }
            50% { opacity: 1; }
        }

        .input-placeholder::before {
            content: attr(data-placeholder);
            color: #4a5568;
            opacity: 0.7;
        }

        /* Hide keyboard on larger screens */
        @media (min-width: 768px) {
            .custom-keyboard {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

<div class="container mx-auto max-w-4xl p-8 rounded-3xl bg-gray-800 shadow-2xl border border-gray-700">
    <div class="text-center mb-10">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-blue-400 mb-2 drop-shadow-lg">CODM Loadouts for YOU!!</h1>
        <p class="text-lg sm:text-xl text-gray-400">Optimize your attachments for victory!</p>
        <p class="text-md sm:text-lg text-gray-500 italic mt-2">If the attachments are not in the game or do not exist, regenerate the loadout.</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Input Section -->
        <div class="bg-gray-700 rounded-2xl p-6 shadow-xl border border-gray-600">
            <h2 class="text-2xl font-bold mb-4 text-gray-200">Weapon and Playstyle</h2>
            <div class="space-y-6">
                <div>
                    <label for="weapon" class="block text-sm font-medium text-gray-400">Weapon Name</label>
                    <div class="relative mt-1 block w-full rounded-lg border-gray-600 bg-gray-900 text-white shadow-sm p-3 focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-blue-500 transition-all duration-300 flex items-center cursor-pointer">
                        <span id="weaponDisplay" class="flex-grow min-h-[1.5rem] overflow-hidden whitespace-nowrap input-placeholder" data-placeholder="e.g., Kilo 141"></span>
                        <span id="weaponCursor" class="typing-indicator hidden"></span>
                    </div>
                </div>
                <div>
                    <label for="playstyle" class="block text-sm font-medium text-gray-400">Playstyle</label>
                    <div class="relative mt-1 block w-full rounded-lg border-gray-600 bg-gray-900 text-white shadow-sm p-3 focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-blue-500 transition-all duration-300 flex items-center cursor-pointer">
                        <span id="playstyleDisplay" class="flex-grow min-h-[1.5rem] overflow-hidden whitespace-nowrap input-placeholder" data-placeholder="e.g., Aggressive"></span>
                        <span id="playstyleCursor" class="typing-indicator hidden"></span>
                    </div>
                </div>
                <div>
                    <label for="details" class="block text-sm font-medium text-gray-400">Specific Details (Optional)</label>
                    <div class="relative mt-1 block w-full rounded-lg border-gray-600 bg-gray-900 text-white shadow-sm p-3 focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-blue-500 transition-all duration-300 flex items-center cursor-pointer min-h-[4rem]">
                        <span id="detailsDisplay" class="flex-grow min-h-[1.5rem] overflow-hidden whitespace-nowrap input-placeholder" data-placeholder="e.g., for ranked matches"></span>
                        <span id="detailsCursor" class="typing-indicator hidden"></span>
                    </div>
                </div>
                <div class="flex justify-center">
                    <button id="generateBtn" class="w-full sm:w-auto px-6 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-bold rounded-full shadow-lg hover:from-blue-600 hover:to-indigo-700 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 transition-all duration-300 transform hover:scale-105">
                        <span id="buttonText">Generate Loadout</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Output Section -->
        <div class="bg-gray-700 rounded-2xl p-6 shadow-xl border border-gray-600 flex flex-col">
            <h2 class="text-2xl font-bold mb-4 text-gray-200">Recommended Loadout</h2>
            <div id="loadingIndicator" class="hidden flex items-center justify-center space-x-2 text-blue-400 py-10">
                <div class="relative flex h-3 w-3">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-3 w-3 bg-blue-500"></span>
                </div>
                <span class="text-lg">Generating...</span>
            </div>
            <div id="resultBox" class="flex-grow p-4 bg-gray-900 rounded-lg border border-gray-600 min-h-[200px] overflow-auto">
                <div id="attachments" class="text-lg text-gray-300">
                    <p class="text-gray-500 text-center py-8">Your generated loadout will appear here.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Box for API Key Errors -->
    <div id="messageBox" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-red-800 border border-red-700 rounded-xl p-6 shadow-2xl max-w-sm w-full text-center">
            <h3 class="text-xl font-bold text-red-200 mb-2">API Key Error</h3>
            <p class="text-red-300">Please provide a valid API key in the code.</p>
            <button id="closeMessage" class="mt-4 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all duration-300">OK</button>
        </div>
    </div>
</div>

<!-- Custom Keyboard HTML -->
<div id="customKeyboard" class="custom-keyboard">
    <div class="key-row">
        <button class="key-button" data-key="1">1</button>
        <button class="key-button" data-key="2">2</button>
        <button class="key-button" data-key="3">3</button>
        <button class="key-button" data-key="4">4</button>
        <button class="key-button" data-key="5">5</button>
        <button class="key-button" data-key="6">6</button>
        <button class="key-button" data-key="7">7</button>
        <button class="key-button" data-key="8">8</button>
        <button class="key-button" data-key="9">9</button>
        <button class="key-button" data-key="0">0</button>
    </div>
    <div class="key-row">
        <button class="key-button" data-key="q">Q</button>
        <button class="key-button" data-key="w">W</button>
        <button class="key-button" data-key="e">E</button>
        <button class="key-button" data-key="r">R</button>
        <button class="key-button" data-key="t">T</button>
        <button class="key-button" data-key="y">Y</button>
        <button class="key-button" data-key="u">U</button>
        <button class="key-button" data-key="i">I</button>
        <button class="key-button" data-key="o">O</button>
        <button class="key-button" data-key="p">P</button>
    </div>
    <div class="key-row">
        <button class="key-button" data-key="a">A</button>
        <button class="key-button" data-key="s">S</button>
        <button class="key-button" data-key="d">D</button>
        <button class="key-button" data-key="f">F</button>
        <button class="key-button" data-key="g">G</button>
        <button class="key-button" data-key="h">H</button>
        <button class="key-button" data-key="j">J</button>
        <button class="key-button" data-key="k">K</button>
        <button class="key-button" data-key="l">L</button>
    </div>
    <div class="key-row">
        <button class="key-button special-key shift-key" data-key="Shift">⇧</button>
        <button class="key-button" data-key="z">Z</button>
        <button class="key-button" data-key="x">X</button>
        <button class="key-button" data-key="c">C</button>
        <button class="key-button" data-key="v">V</button>
        <button class="key-button" data-key="b">B</button>
        <button class="key-button" data-key="n">N</button>
        <button class="key-button" data-key="m">M</button>
        <button id="backspaceKey" class="key-button special-key backspace-key" data-key="Backspace">⌫</button>
    </div>
    <div class="key-row">
        <button class="key-button special-key comma-key" data-key=",">,</button>
        <button class="key-button space-key" data-key=" "></button>
        <button class="key-button special-key period-key" data-key=".">.</button>
        <button class="key-button special-key done-key" data-key="Done">Done</button>
    </div>
</div>

<script>
    const generateBtn = document.getElementById('generateBtn');
    const weaponDisplay = document.getElementById('weaponDisplay');
    const playstyleDisplay = document.getElementById('playstyleDisplay');
    const detailsDisplay = document.getElementById('detailsDisplay');
    const weaponCursor = document.getElementById('weaponCursor');
    const playstyleCursor = document.getElementById('playstyleCursor');
    const detailsCursor = document.getElementById('detailsCursor');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const attachmentsDiv = document.getElementById('attachments');
    const messageBox = document.getElementById('messageBox');
    const closeMessageBtn = document.getElementById('closeMessage');
    const customKeyboard = document.getElementById('customKeyboard');
    const keyboardKeys = customKeyboard.querySelectorAll('.key-button');
    const inputDisplays = {
        weapon: weaponDisplay,
        playstyle: playstyleDisplay,
        details: detailsDisplay
    };
    const inputCursors = {
        weapon: weaponCursor,
        playstyle: playstyleCursor,
        details: detailsCursor
    };
    const inputContainers = {
        weapon: document.getElementById('weaponDisplay').parentElement,
        playstyle: document.getElementById('playstyleDisplay').parentElement,
        details: document.getElementById('detailsDisplay').parentElement
    };

    let activeInputId = null;
    let isShifted = false;
    let backspaceInterval = null;
    const isMobile = window.matchMedia("(max-width: 768px)").matches;

    const API_KEY = "AIzaSyDHOsep4QtiL0WRmPw47WRC2PVEHhaiNg8"; // PASTE YOUR API KEY HERE
    
    function showMessageBox(message) {
        const messageText = messageBox.querySelector('p');
        messageText.textContent = message;
        messageBox.classList.remove('hidden');
    }

    closeMessageBtn.addEventListener('click', () => {
        messageBox.classList.add('hidden');
    });

    async function fetchWithBackoff(url, options, retries = 3, delay = 1000) {
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                if (response.status === 401) {
                    throw new Error("Invalid API key. Please check your key.");
                }
                const errorData = await response.json();
                throw new Error(errorData.error.message || `API error with status: ${response.status}`);
            }
            return response;
        } catch (error) {
            if (retries > 0 && error.message.includes("API error")) {
                console.warn(`Retrying in ${delay}ms...`);
                await new Promise(res => setTimeout(res, delay));
                return fetchWithBackoff(url, options, retries - 1, delay * 2);
            }
            throw error;
        }
    }

    if (isMobile) {
        // Set up click listeners for the display spans
        Object.keys(inputContainers).forEach(id => {
            inputContainers[id].addEventListener('click', () => {
                if (activeInputId) {
                    inputCursors[activeInputId].classList.add('hidden');
                }
                activeInputId = id;
                inputCursors[activeInputId].classList.remove('hidden');
                customKeyboard.classList.add('is-visible');
            });
        });

        // Handle key presses on the custom keyboard
        keyboardKeys.forEach(key => {
            key.addEventListener('click', () => {
                if (!activeInputId) return;

                const keyValue = key.getAttribute('data-key');
                let currentText = inputDisplays[activeInputId].textContent;
                
                // Remove placeholder class when user starts typing
                inputDisplays[activeInputId].classList.remove('input-placeholder');

                switch (keyValue) {
                    case 'Done':
                        customKeyboard.classList.remove('is-visible');
                        inputCursors[activeInputId].classList.add('hidden');
                        activeInputId = null;
                        break;
                    case 'Backspace':
                        inputDisplays[activeInputId].textContent = currentText.slice(0, -1);
                        if (inputDisplays[activeInputId].textContent === '') {
                            inputDisplays[activeInputId].classList.add('input-placeholder');
                        }
                        break;
                    case 'Shift':
                        isShifted = !isShifted;
                        // Visually update the keys
                        keyboardKeys.forEach(k => {
                            const keyVal = k.getAttribute('data-key');
                            if (keyVal.length === 1 && keyVal.match(/[a-z]/i)) {
                                k.textContent = isShifted ? keyVal.toUpperCase() : keyVal.toLowerCase();
                            }
                        });
                        break;
                    default:
                        const char = isShifted ? keyValue.toUpperCase() : keyValue.toLowerCase();
                        inputDisplays[activeInputId].textContent += char;
                        isShifted = false; // Reset shift after a letter is typed
                }
            });
        });

        // Continuous backspace logic
        const backspaceKey = document.getElementById('backspaceKey');
        backspaceKey.addEventListener('mousedown', (e) => {
            e.preventDefault();
            deleteCharacter();
            backspaceInterval = setInterval(deleteCharacter, 100);
        });
        backspaceKey.addEventListener('mouseup', () => {
            clearInterval(backspaceInterval);
        });
        backspaceKey.addEventListener('touchstart', (e) => {
            e.preventDefault();
            deleteCharacter();
            backspaceInterval = setInterval(deleteCharacter, 100);
        });
        backspaceKey.addEventListener('touchend', () => {
            clearInterval(backspaceInterval);
        });
        
        function deleteCharacter() {
            if (!activeInputId) return;
            const currentText = inputDisplays[activeInputId].textContent;
            if (currentText.length > 0) {
                inputDisplays[activeInputId].textContent = currentText.slice(0, -1);
            }
            if (inputDisplays[activeInputId].textContent === '') {
                inputDisplays[activeInputId].classList.add('input-placeholder');
            }
        }
    } else {
        // Desktop version
        Object.keys(inputDisplays).forEach(id => {
            const inputEl = inputDisplays[id];
            inputEl.setAttribute('contenteditable', 'true');
            inputCursors[id].classList.add('hidden');
            inputEl.addEventListener('focus', () => inputEl.classList.remove('input-placeholder'));
            inputEl.addEventListener('blur', () => {
                if (inputEl.textContent.trim() === '') {
                    inputEl.classList.add('input-placeholder');
                }
            });
        });
        customKeyboard.style.display = 'none';
    }


    generateBtn.addEventListener('click', async () => {
        const weapon = weaponDisplay.textContent.trim();
        const playstyle = playstyleDisplay.textContent.trim();
        const details = detailsDisplay.textContent.trim();

        if (API_KEY === "") {
            showMessageBox("Please provide a valid API key in the code.");
            return;
        }

        if (!weapon) {
            showMessageBox("Please enter a weapon name.");
            return;
        }

        loadingIndicator.classList.remove('hidden');
        generateBtn.disabled = true;
        document.getElementById('buttonText').textContent = '';
        attachmentsDiv.innerHTML = '';

        const systemPrompt = "You are a professional Call of Duty Mobile loadout creator. When given a weapon, your first step is to perform a Google search to find a comprehensive, updated list of ALL available attachments for that specific gun in the current year, 2025. You must use the exact, full names of the attachments as they appear in the game, for example, '30 Rnd' instead of '30 Round Extended Mag'. You will use ONLY attachments from this verified list. Based on the user's weapon, playstyle, and any additional details, provide a specific list of five attachments. For each attachment, format the output as 'Part of weapon: Attachment Name'. For example, 'Muzzle: Monolithic Suppressor'. Do not include any other text or explanation, just the list of attachments with this format.";
        const userQuery = `Weapon: ${weapon}. Playstyle: ${playstyle}. Details: ${details}`;

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            tools: [{ "google_search": {} }]
        };

        try {
            const response = await fetchWithBackoff(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            const candidate = result.candidates?.[0];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                const text = candidate.content.parts[0].text;
                const lines = text.split('\n').filter(line => line.trim() !== '');

                let htmlContent = '<ul class="list-disc list-inside space-y-2">';
                lines.forEach(line => {
                    const parts = line.split(':');
                    if (parts.length === 2) {
                        const partType = parts[0].trim();
                        const attachmentName = parts[1].trim();
                        htmlContent += `<li><span class="text-blue-400 font-bold">${partType}:</span> ${attachmentName}</li>`;
                    }
                });
                htmlContent += '</ul>';
                attachmentsDiv.innerHTML = htmlContent;
            } else {
                attachmentsDiv.innerHTML = `<p class="text-red-400 text-center">Sorry, I couldn't generate a loadout. Please try again.</p>`;
            }

        } catch (error) {
            console.error('API call failed:', error);
            attachmentsDiv.innerHTML = `<p class="text-red-400 text-center">Error: ${error.message}</p>`;
        } finally {
            loadingIndicator.classList.add('hidden');
            generateBtn.disabled = false;
            document.getElementById('buttonText').textContent = 'Generate Loadout';
        }
    });
</script>

</body>
</html>
